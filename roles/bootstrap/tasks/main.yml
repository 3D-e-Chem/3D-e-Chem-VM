---
- name: Update APT package cache
  apt: update_cache=yes
- name: Install reboot notifier
  apt: name=update-notifier-common
- name: Remove chef
  apt: name=chef state=absent
- name: Upgrade APT to the lastest packages
  apt: upgrade=full
- name: Set locale
  command: /usr/sbin/update-locale LC_ALL=en_US.utf8
- name: Create /opt directory
  file: path=/opt state=directory
- name: Rebooting machine so new kernel is active
  command: shutdown -r now removes=/var/run/reboot-required
  async: 0
  poll: 0
  ignore_errors: true
  register: restarted
- name: Waiting for reboot...
  local_action: wait_for host={{ ansible_ssh_host | default(inventory_hostname) }} search_regex=OpenSSH port=22 delay=15 state=started
  sudo: no
  when: restarted.changed
- name: Create ~/.ssh directory
  file: path=/home/vagrant/.ssh state=directory mode="0700" owner=vagrant group=vagrant
- name: Add insecure vagrant key
  # public key from https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub
  lineinfile: dest=/home/vagrant/.ssh/authorized_keys mode="u=rw" owner=vagrant group=vagrant line="ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key" create=yes state=present
